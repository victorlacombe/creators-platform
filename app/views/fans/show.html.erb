<div class="container">
  <div class="header">
    <%= link_to "Back to my fans", fans_path%>
  </div>
  <div class="content">
    <div class="left-card">
      <%= image_tag  @fan.profile_picture_url.gsub(/\/s28-/, '/s300-'), class: "avatar-large" %>
      <div class="pseudo btn-tab">
        <a href="http://youtube.com/channel/<%= @fan.channel_id_youtube %>" target="_blank"><%= @fan.youtube_username %></a>
      </div>

      <% comments = Comment.where(fan_id: @fan) %>
      <% comment = comments.order(published_at: :desc).first %>
      <% if comment %>
        <p class="last-msg">Last message :</p>
        <p class="last-msg"><% c = comment.published_at %></p>
        <p class="last-msg"><%= c.strftime("%e %b %Y %H:%M") %></p>
      <% end %>
      <%= simple_form_for @memo do |f|%>
        <%= f.input :content%>
        <%= f.submit "Save", class: "memo-btn"%>
      <% end %>
    </div>
    <div class="all-videos">
      <% @comments_by_video.each do |video_id, comments|%>
        <!-- ---------------------------------------------------------------------------- -->
        <!-- ----------------This is the video thumbnail left of the comments------------ -->
        <!-- ---------------------------------------------------------------------------- -->
        <div class="video-comment-card">
          <% video = Video.find(video_id) %>
          <div class="video-card">
            <%= link_to "http://youtube.com/watch?v=" + video.video_id_youtube, target: '_blank' do %>
              <%= image_tag  video.thumbnail, class: "avatar-square" %>
            <% end %>
            <div class='btn-tab'>
              <%= link_to video.title.first(20), "http://youtube.com/watch?v=" + video.video_id_youtube, target: '_blank' %>
            </div>
          </div>
        <!-- --------------------------------------------------------- -->
        <!-- ---------------- This is the comments section------------ -->
        <!-- --------------------------------------------------------- -->
          <div class="comments">
            <% previous_comment = nil %>
            <% comments.each do |comment|%>
              <!-- --separator between different discussion/parents comment-- -->
              <% unless previous_comment.nil? %>
                <% unless previous_comment.top_level_comment_id_youtube == comment.top_level_comment_id_youtube %>
                  <hr>
                <% end %>
              <% end %>

              <!-- Variables to know if it's a parent comment and if it's the creator himself -->
              <% is_parent_comment = comment.top_level_comment_id_youtube == comment.comment_id_youtube %>
              <% is_creator = comment.fan_id == @creator_fan_id %>

              <!-- displaying the comment with correct classes -->
              <div class="comment-card <%= is_parent_comment ? 'parent-comment' : 'child-comment'  %> <%= 'creator-comment' if is_creator %>">
                <p class="date">
                  <% if is_creator %><%= image_tag  Fan.find(comment.fan_id).profile_picture_url, class: "avatar-square" %><% end %>
                  <%= link_to "http://youtube.com/watch?v=" + video.video_id_youtube + "&lc=" + comment.comment_id_youtube, target: '_blank' do %>
                    <%= comment.published_at.strftime("%e %b %Y %H:%M") %>
                  <% end %>
                </p>
                <div class="txt">
                  <%= comment.content.html_safe %>
                </div>
              </div>

              <!-- we set a previous_comment variable so we can track change of discussion (different parent comment) -->
              <% previous_comment = comment %>
            <%end %>
          </div>
        </div>
      <%end %>
    </div>
  </div>
</div>
